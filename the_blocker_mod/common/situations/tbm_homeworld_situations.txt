### The Blocker Mod - Homeworld Situations

@post_apoc_population = 0
@colonial_farmsteads = 0


### Index
#
# 01. Food Reserves Run Low - Post-Apocalyptic Origin, Food Rations feature
###


# 01. Food Reserves Running Out - Triggers 15 years after start if Food Rations exists
food_reserves_run_out = {

	desc = {
		text = food_reserves_run_out_desc_gestalt	# Loc overwrite for gestalts
		trigger = { owner = { is_gestalt = yes }}
	}

	picture = GFX_evt_deficit

	category = negative

	complete_icon = GFX_situation_outcome_positive
	complete_icon_frame = GFX_situation_outcome_frame_green
	fail_icon = GFX_situation_outcome_revolt
	fail_icon_frame = GFX_situation_outcome_frame_red

	on_start = {
		hidden_effect = {
			target = {
				save_global_event_target_as = post_apoc_homeworld	# This is needed for events and such.
				export_trigger_value_to_variable = {	# Has to be checked here to get initial upkeep for approaches.
					trigger = num_pops
					variable = @post_apoc_population
				}
			}
		}
	}

	# 100 = Colonial Bounty
	on_progress_complete = {
		# Add positive modifier
		# Remove Food Rations, we're autarkic now! (And begin Eco-restimulation Project.)
	}

	# 0 = Widespread Starvation
	on_fail = {
		# Apply Widespread Starvation modifier to planet
		# Remove Food Rations
	}

	start_value = 20	# Five years of food left
	progress_direction = bidirectional
	complete_category = positive
	fail_category = negative

	monthly_progress = {
		base = 1	# Always 1 with this unless we do it per pop with script_values (later, maybe)

		# Only way to add more food is to ship it from a colony's surplus.
		modifier = {
			add = @colonial_farmsteads	# This will be 0 until you create some.
			desc = colonial_farmsteads_tooltip
		}
	}

	stages = {
		
		# Food Reserevs Low - Starting Stage
		food_reserves_low = {
			icon = GFX_situation_stage_1
			icon_background = GFX_situation_stage_frame_blue
			end = 80
			on_first_enter = {
				# Food Rations Run Out Event
			}
			target_modifier = {
				planet_crime_add = 20
				biological_pop_happiness = -0.2
				BIOLOGICAL_pop_growth_speed = -0.2
			}
		}

		# Colonial Plenty
		colonial_plenty = {
			icon = GFX_situation_stage_2
			icon_background = GFX_situation_stage_frame_green
			end = 100
			target_modifier = {
				pop_happiness = 0.2
			}
		}
	}

	# Colonial Land Grants - Must have at least one off-world colony
	approach = {
		name = colonial_land_grants
		icon = GFX_situation_approach_kneel
		icon_background = GFX_situation_approach_bg_yellow
		allow = {
			owner = {
				any_owned_planet = {
					NOT = { 
						is_same_value = event_target:post_apoc_homeworld
					}
				}
			}
		}
		
		# Adds Frontier Farmsteads to a colony.
		on_select = {
			if = {
				limit = {
					NOT = { has_situation_flag = land_grants } 	# Don't allow this approach to grants its effects twice.
				}
				owner = {
					random_owned_planet = {
						limit = {
							NOT = { 
								is_same_value = event_target:post_apoc_homeworld
							}
						}
						
						save_event_target_as = colonial_bounty
	
						add_deposit = d_frontier_farmstead
						add_deposit = d_frontier_farmstead
						add_deposit = d_frontier_farmstead
						add_deposit = d_frontier_farmstead
						add_modifier = {
							modifier = beacon_of_hope
							years = 10
						}
					}
				}
				set_situation_flag = land_grants
			}
			
			hidden_effect = {	# This is re-checked every time you select it.
				target = {
					export_trigger_value_to_variable = {
						trigger = num_pops
						variable = @post_apoc_population
					}
				}
			}
		}

		target_modifier = {
			planet_emigration_push_add = 75
			pop_cat_worker_happiness = 0.25
		}
	}

	# Colonial Food Shipments
	approach = {
		name = colonial_food_shipments	# Set colonial_food_shipments_desc "Begin sending food shipments from the colony to replenish the Food Rations."
		icon = GFX_situation_approach_fleet
		icon_background = GFX_situation_approach_bg_green
		allow = {
			#has_situation_flag = land_grants	# Cannot start shipping without the land grants; also, we need to make sure we have the colony as a scope.
			OR = {
				owner = {
					any_owned_planet = {
						NOT = { 
							is_same_value = event_target:post_apoc_homeworld
						}
						num_districts = {
							type = district_farming
							value > 0
						}
					}
				}
				owner = {
					custom_tooltip = {
						fail_text = colonial_food_shipments_must_have_land_grants	# This has to show if a planet hasn't been given land grants.
					}
					any_owned_planet = {
						exists = owner
						is_same_value = event_target:colonial_bounty
					}
				}
			}
		}
		on_select = {
			hidden_effect = {
				owner = {
					random_owned_planet = {
						limit = {
							OR = {
								owner = {
									any_owned_planet = {
										NOT = { 
											is_same_value = event_target:post_apoc_homeworld
										}
										num_districts = {
											type = district_farming
											value > 0
										}
									}
								}
								owner = {
									# custom_tooltip = {
									# 	fail_text = colonial_food_shipments_must_have_land_grants	# This has to show if a planet hasn't been given land grants.
									# }
									any_owned_planet = {
										is_same_value = event_target:colonial_bounty
									}
								}
							}
						}
						export_trigger_value_to_variable = {
							trigger = num_assigned_jobs
							parameters = {
								job = farmer
							}
							variable = @colonial_farmsteads
						}
					}
				}
			}
		}

		target_modifier = {
			pop_happiness = 0.2
		}

		resources = {
			category = country_situations
			upkeep = {
				food = 1
				mult = @post_apoc_population
			}
		}
	}

	
	# Hoard & Control
	approach = {
		name = hoard_control
		icon = GFX_situation_approach_sword
		icon_background = GFX_situation_approach_bg_yellow
		potential = {
			owner = { NOT = { is_egalitarian = yes }}
			NOT = { has_situation_flag = widespread_starvation }
		}
		target_modifier = {
			planet_crime_add = 25
			pop_cat_ruler_happiness = 0.20
			pop_ethic_egalitarian_attraction_mult = 0.5
		}
	}
	
	# Strict Rationing - DEFAULT
	approach = {
		name = strict_rationing
		icon = GFX_situation_approach_this_is_fine
		icon_background = GFX_situation_approach_bg_yellow
		default = yes
		potential = {
			NOT = { has_situation_flag = widespread_starvation }
		}
		target_modifier = {
			job_enforcer_add = 2
			planet_crime_add = 10
			pop_ethic_egalitarian_attraction_mult = 0.25
		}
	}

	# Widespread Starvation
	approach = {
		name = widespread_starvation
		icon = GFX_situation_approach_pop
		icon_background = GFX_situation_approach_bg_red
		target_modifier = {
			planet_stability_add = -30
			planet_crime_add = 10
		}
	}

	on_monthly = {
		
		# First event is hiden and checks montly the farmers on the colony and sets @colony_farmsteads

		# Negative Events
		# Food Riots
		# Privately Sponsored Colony?
		# Homeworld gov assassinated and/or eaten
	}
}